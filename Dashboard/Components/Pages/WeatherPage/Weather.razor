@page "/weather"
@using Dashboard.Services
@using Dashboard.Model
@using Microsoft.EntityFrameworkCore
@inject WeatherApiService WeatherApiService
@inject Dashboard.Connect.DashboardDbContext DbContext
@inject Dashboard.Services.LoginService LoginService

@if (weatherData != null)
{
    <div class="weather-card">
        <h2><strong>@weatherData.City</strong></h2>
        <img src="@weatherData.IconUrl" alt="Weather Icon" />
        <div class="weather-info">
            <p class="temperature">Temperature: @weatherData.RoundedTemperature &deg;C</p>
            <p><strong>Weather:</strong> @weatherData.WeatherMain</p>
            <p><strong>Description:</strong> @weatherData.WeatherDescription</p>
            <p><strong>Humidity:</strong> @weatherData.Humidity %</p>
            <p><strong>Wind Speed:</strong> @weatherData.WindSpeed m/s</p>
            <p><strong>Timestamp:</strong> @weatherData.Timestamp</p>
        </div>
    </div>
}
else if (loading)
{
    <p>Loading...</p>
}
else
{
    <p>No data available. Please try again later.</p>
}

@code {
    private WeatherData weatherData;
    private bool loading;
    private string city;

    protected override async Task OnInitializedAsync()
    {
        await SetCityAndFetchWeather();
    }

    private async Task SetCityAndFetchWeather()
    {
        loading = true;

        // Determine the city to fetch weather for
        if (LoginService.IsLoggedIn)
        {
            var user = await DbContext.Users
                .Include(u => u.Location) // Ensure Location is included
                .FirstOrDefaultAsync(u => u.Id == LoginService.Id);

            if (user?.Location != null)
            {
                city = user.Location.CityName;
            }
            else
            {
                city = "London"; // Default city if location not found
            }
        }
        else
        {
            city = "London"; // Default city for non-logged-in users
        }

        // Fetch the weather data
        weatherData = await WeatherApiService.GetWeatherAsync(city);
        loading = false;
    }
}
